name: PR Preview Deploy (Netlify - Next)

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  deploy_preview:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      - name: Install netlify CLI
        run: npm i -g netlify-cli
      - name: Netlify build (uses @netlify/plugin-nextjs)
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
        run: |
          netlify build --context=deploy-preview
      - name: Deploy to Netlify (preview)
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
        run: |
          netlify deploy --auth="$NETLIFY_AUTH_TOKEN" --site="$NETLIFY_SITE_ID" --dir=".netlify/output/public" --json > netlify-deploy.json
          node -e "console.log(JSON.parse(require('fs').readFileSync('netlify-deploy.json')).url)" > preview_url.txt
      - name: Comment PR with preview URL
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs')
            const url = fs.readFileSync('preview_url.txt','utf8').trim()
            const pr = context.payload.pull_request.number
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr,
              body: `Netlify preview deployed: ${url}`
            })

# Notes:
# - Requires repo secrets: NETLIFY_AUTH_TOKEN and NETLIFY_SITE_ID
# - This workflow uses Netlify's Next.js plugin to build serverful Next apps and deploy the output for previews.
# - Ensure `netlify.toml` is present at repo root with the plugin configured.
# - For production deploys via Netlify UI, configure Site settings / build & deploy as usual.

